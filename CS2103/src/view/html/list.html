<!DOCTYPE html>
<!-- @@author A0149527W -->
<html>
<head>
 <meta charset="utf-8" />
 <title>J.Listee</title>
 <link href="../css/bootstrap.min.css" rel="stylesheet">
 <script src="../js/jquery-1.11.1.min.js"></script>
 <script src="../js/bootstrap.min.js"></script>
 <style>
  body{
    background: rgba(0,0,0,0);
  }
   .center {
     width: 800px;
     text-align: center;
   }
   .list{ 
    height:503px;
    padding: 15px;
    padding-right: 5px;
    background-color:rgba(238,238,238,0.9);
    overflow-y:scroll;
  }

  .commandline{
    background-color: #726e6e;
    height: 55px;
  }

  .grouptitle{
    font-size: 25px;
    color: #888;
    font-weight: 100;
    margin: 5px;
  }
  .title{
    font-size: 26px;
    color: #555;
    font-weight: 100;
  }
  section{
    display: inline-block;
  }
  .task{
    width: 100%;
    height:65px;
    border-radius: 8px;
    background-color: rgba(255,255,255,0.7);
    margin: 8px 0;
    vertical-align: middle;
  }
  .task:focus{
    background-color: rgba(255,255,255,1.0);
    outline: 0;
    border-radius: 8px;
    box-shadow: 0 0 0 1.5px #ccc;
  }
  .conflict{
    outline: 0;
    border-radius: 8px;
    box-shadow: 0 0 0 1.5px #ccc;
  }
  .task_number{
    width:7%;
    height: 100%;
    border-radius: 8px 0 0 8px;
    background-color: rgba(131,207,203,0.8);
    font-size: 35px;
    line-height: 65px;
    color: #444;
    float: left;
  }
  .overdue .task_number{
    background-color: rgba(235,131,99,0.8);
  }
  .task_middle{
    display:table;
    float: left;
    width:72.5%;
    height: 100%;
    text-align: left;
    padding:5px 0px 5px 10px;
  }
  .task_right{
    float: right;
    height: 100%;
    display: table;
    width: 19.5%;
    padding: 5px 8px 5px 5px;
    text-align: right;
  }

  .task_description{
    font-size: 18px;
  }
  .time{
    font-size: 14px;
  }
  .time>div{
    vertical-align: middle;
    display: table-cell;
    padding: 0 4px;
  }
  .time span{
    padding: 1px 8px;
    display: block;
    border-radius: 3px;
  }
  .task_components,.task_location,.task_tags{
    margin: 4px 5px 4px 0px;
  }
  .task_middle .task_components{
    display:table-row;
    height: 50%;
  }
  #description{
    display: table-cell;
    vertical-align: middle;
  }
  .task_middle section,.task_middle span{
    line-height: 14px;
    height:20px;
    border-radius: 3px;
    padding: 2px;
    text-align: center;
  }
  .task_location{    
    background-color: rgba(63,190,122,0.4);    
  }
  .task_tags span{
    background-color: #d8d8d8;
    margin-right: 5px;
  }
  .task_right>div{
    display: table-row;
  }
  .task_lowertime span{
    background-color: rgba(240,108,125,0.4);
  }
  .task_uppertime span{
    background-color: rgba(0,181,242,0.4);
  }
  #tasklist_deadline .time{
    position: relative;
    top: 23%;
  }
  form{
    width: 100%;
    height: 100%;
  }
  input{
    width: 100%;
    height: 100%;
    background: transparent;
    color: #fff;
    border: 0;
    outline:none;
    line-height: 30px;
    font-size: 20px;
    padding: 15px;
  }
  .alert{
    position:absolute;
    display:none;
    bottom: 97px;
    margin-bottom: 0;
    width: 800px;
    height: 40px;
    padding: 10px;
  }
  .reserved .reserve_list{
    padding: 0;
    width: 100%;
    height: 100%;
    margin: 0 auto;
  }
  .timeslot{
    width: 33%;
    padding: 10px 9px 10px 0;
    float: right;
    height: 65px;
    background-color: #dfdfdf;
    margin-left: 1px;
  }
  .reserved .task_middle{
    width:43%;
  }
  .reserved .task_right{
    padding: 0;
    width: 50%;
  }
  #timeslot1{
    border-radius: 0 8px 8px 0;
  }
  #suggestion-bar{
    width: 800px;
    display: none;
  }
  .arrow-up {
    width: 0;
    height: 0;
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 7px solid #333;
    position: relative;
    left: 30px;
  }
  .command_suggestion{
    height: 35px;
    background-color: #333;
    width: 100%;
    border-radius: 10px;
    color: #ddd;
    font-size: 18px;
    padding: 5px 15px;
  }

</style>
</head>
<body>
  <script  type="text/javascript">
    var i=0;

    function reset(){
      i=0;
    }

    function reload() {
      window.location.reload();
    }
    
    function addReservedTask(jsonTasks){
      var taskList = JSON.parse(jsonTasks);

      if(taskList.length==0)
        return;

      var tasklist_=document.getElementById("tasklist_reserved");
      $(reserved_title).text("Reserved");
      
      //remove all existing children
      while (tasklist_.firstChild) {
        tasklist_.removeChild(tasklist_.firstChild);
      }

      for  (index = 0; index < taskList.length; index++){

        var taskdiv = document.createElement("div");
        taskdiv.setAttribute("class", "task");
        taskdiv.setAttribute("tabindex", "0");
        taskdiv.setAttribute("id", i+1);

        //restric displaying discription length
        var description="";
        if(taskList[index].description.length<24){
          description=taskList[index].description;
        }else{
          description=taskList[index].description.substring(0,23)+"...";
        }

        taskdiv.innerHTML= "<section class='task_number'>"
        + (i+1)
        + "</section>"
        + "<section class='task_middle' id='task_middle'>"
        + "<div class='task_components task_description' id='task_description"
        + i
        + "'>"
        + "<div id='description'>"
        + description
        +"</div>"
        + "</div>"
        + "<div class='task_components' id='task_details"
        + i
        +"'>"
        + "<section class='task_location' id='task_location"
        + i
        +"'>"

        + "</section>"
        + "<section class='task_tags' id='task_tags"
        + i
        +"'>"

        + "</section>"
        + "</div>"
        + "</section>"
        + "<section class='task_right'>"
        + "<div class='reserve_list' id='timeslot_list"
        + i
        +"'>"
       
        + "</div> "
        + "</section>"

        tasklist_.appendChild(taskdiv);

        var task_location=document.getElementById("task_location"+i);
        var task_tags=document.getElementById("task_tags"+i);
        var task_details=document.getElementById("task_details"+i);
        var timeslot_list=document.getElementById("timeslot_list"+i);

        if(taskList[index].location==undefined && taskList[index].tags.length==0){
          task_details.style.display="none";
        }else{
         //add location if necessary
         if(taskList[index].location!=undefined){
           var locationspan = document.createElement("span");
           locationspan.innerHTML="@"+taskList[index].location;
           task_location.appendChild(locationspan);
         }
         else{
           task_location.style.display="none";
         }

         //add tags if necessary at most 4
         if(taskList[index].tags.length>0){

          if(taskList[index].tags.length>4){
            taskList[index].tags[3]="...";
          }
          
          for  (index2 = 0; index2 < taskList[index].tags.length && index2 < 4; index2++){
           var tagspan = document.createElement("span");
           tagspan.innerHTML="#"+taskList[index].tags[index2];
           task_tags.appendChild(tagspan);
          }
         }
         else{
           task_tags.style.display="none";
         }
        }
        var len=taskList[index].startDates.length;
        //add timeslots at most 3
        for( index3 =len-1; index3>=0 && len-index3<4; index3--){
           var timeslot = document.createElement("div");
           timeslot.setAttribute("class", "timeslot");
           timeslot.setAttribute("id", "timeslot"+(len-index3));
           timeslot.innerHTML=taskList[index].startDates[index3]+"<br>"+taskList[index].endDates[index3];
           timeslot_list.appendChild(timeslot);
        }

        i=i+1;
      }
    }

    function addTasks(jsonTasks, type){
      var taskList = JSON.parse(jsonTasks);

      if(taskList.length==0)
        return;

      if(type=="deadline"){
        var tasklist_=document.getElementById("tasklist_deadline");
        $(deadline_title).text("Deadlines");
      }else if(type=="event"){
        var tasklist_=document.getElementById("tasklist_event");
        $(event_title).text("Events");
      }else if(type=="floating"){
        var tasklist_=document.getElementById("tasklist_floating");
        $(float_title).text("Untimed");
      }else if(type=="completed"){
        var tasklist_=document.getElementById("tasklist_mixed");
        $(title).text("Completed Tasks");
      }

    //remove all existing children
    while (tasklist_.firstChild) {
      tasklist_.removeChild(tasklist_.firstChild);
    }

    for  (index = 0; index < taskList.length; index++){

      //restric displaying discription length
      var description="";
      if(taskList[index].description.length<60){
        description=taskList[index].description;
      }else{
        description=taskList[index].description.substring(0,59)+"...";
      }

      var taskdiv = document.createElement("div");
      if(taskList[index].overdue==true){
        taskdiv.setAttribute("class", "task overdue");
      }else{
        taskdiv.setAttribute("class", "task");
      }
      taskdiv.setAttribute("tabindex", "0");
      taskdiv.setAttribute("id", i+1);

      taskdiv.innerHTML= "<section class='task_number'>"
      + (i+1)
      +"</section>"
      + "<section class='task_middle' id='task_middle'>"
      + "<div class='task_components task_description' id='task_description"
      + i
      + "'>"
    + "<div id=description>"
      + description
    + "</div>"
      +"</div>"
      + "<div class='task_components' id='task_details"
      + i
      +"'>"
      + "<section class='task_location'id='task_location"
      + i
      +"'>"

      +"</section>"
      + "<section class='task_tags' id='task_tags"
      + i
      +"'>"
      + "</div>"
      + "</section>"
      + "</section>"
      + "<section class='task_right'>"
      + "<div class='task_components time task_uppertime' id='task_start_div"
      + i
      + "'>"
      + "<div>"
      + "<span id='task_start"
      + i
      + "'>"
      + "</span>"
      + "</div>"
      +"</div>"
      + " <div class='task_components time task_lowertime' id='task_end_div"
      + i
      + "'>"
        + "<div>"
      + "<span id='task_end"
      + i
      + "'>"
      + "</span>"
      + "</div>"
      +"</div>"
      + "</section>"

      tasklist_.appendChild(taskdiv);

      var task_location=document.getElementById("task_location"+i);
      var task_start=document.getElementById("task_start"+i);
      var task_end=document.getElementById("task_end"+i);
      var task_tags=document.getElementById("task_tags"+i);
      var task_details=document.getElementById("task_details"+i);

      if(taskList[index].location==undefined && taskList[index].tags.length==0){
        task_details.style.display="none";
      }else{
         //add location if necessary
         if(taskList[index].location!=undefined){
           var locationspan = document.createElement("span");
           locationspan.innerHTML="@"+taskList[index].location;
           task_location.appendChild(locationspan);
         }
         else{
           task_location.style.display="none";
         }

         //add tags if necessary
         if(taskList[index].tags.length!=0){
          if(taskList[index].tags.length>4){
            taskList[index].tags[3]="...";
          }
          for  (index2 = 0; index2 < taskList[index].tags.length && index2 < 4; index2++){
           var tagspan = document.createElement("span");
           tagspan.innerHTML="#"+taskList[index].tags[index2];
           task_tags.appendChild(tagspan);
         }
       }
       else{
         task_tags.style.display="none";
       }
     }


     //add startDate if necessary
     if(taskList[index].startDate!=undefined){        
       task_start.innerHTML=taskList[index].startDate;
     }
     else{
       $("#task_start_div"+i).hide();
     }

     //add endDate if necessary
     if(taskList[index].endDate!=undefined){
       task_end.innerHTML= taskList[index].endDate;
     }
     else{
       $("#task_end_div"+i).hide();
     }

     i=i+1;
   }    
 }

 function sendCommand() {
  var command = cmd.elements['command'].value;
  // Invoke the 'receive' Java callback
  app.receiveCommand(command);
  }

function shortCutCommand(cmd){
  app.receiveCommand(cmd);
}

function showFeedBack(feedback){
  $("#feedback").text(feedback);
  $("#feedback").slideToggle("slow");
  setTimeout("hideFeedBack()",2200);
}

function hideFeedBack(){
  $("#feedback").slideToggle();
}

function setFocus(indices){
  var indexList = JSON.parse(indices);

  for(var i=0;i<indexList.length;i++){
    $("#"+indexList[i]).focus();
  }
}

function showConflict(conflics){
  setTimeout(
    function (){
  var indexList = JSON.parse(conflics);

  for(var i=0;i<indexList.length;i++){
    $("#"+indexList[i]).fadeOut(200).fadeIn(200).fadeOut(200).fadeIn(200);
  }
},1000);
}

function addShowAnimation(indices){
  var indexList = JSON.parse(indices);

  for(var i=0;i<indexList.length;i++){
    $("#"+indexList[i]).hide();
  }

  for(var i=0;i<indexList.length;i++){
    $("#"+indexList[i]).toggle(900);
  }
}

function addHideAnimation(indices){
  var indexList = JSON.parse(indices);

  for(var i=0;i<indexList.length;i++){
    var j=parseInt(indexList[i])-i;
    $("#"+j).toggle(900);

    $("#"+j).attr("id",0);
    var index=j+1;
    //update indices of flollowing tasks
    while($("#"+index).length){
      $("#"+index).children("section.task_number").text(index-1);
      $("#"+index).attr("id",index-1);

      index=index+1;
    }
  }
}

function clearCommandLine(){
  $(command).val("");
}

//Prevent the backspace key from navigating back.
$(document).unbind('keydown').bind('keydown', function (event) {
    var doPrevent = false;
    if (event.keyCode === 8) {
        var d = event.srcElement || event.target;
        if ((d.tagName.toUpperCase() === 'INPUT' && 
             (
                 d.type.toUpperCase() === 'TEXT' ||
                 d.type.toUpperCase() === 'PASSWORD' || 
                 d.type.toUpperCase() === 'FILE' || 
                 d.type.toUpperCase() === 'SEARCH' || 
                 d.type.toUpperCase() === 'EMAIL' || 
                 d.type.toUpperCase() === 'NUMBER' || 
                 d.type.toUpperCase() === 'DATE' )
             ) || 
             d.tagName.toUpperCase() === 'TEXTAREA') {
            doPrevent = d.readOnly || d.disabled;
        }
        else {
            doPrevent = true;
        }
    }
    if (doPrevent) {
        event.preventDefault();
    }
});


function getCommandsuggestion()
{
  if(cmd.elements['command'].value==''){
    $("#suggestion-bar").hide();
  }

  //send command when typing
  if(app.getCommandsuggestion(cmd.elements['command'].value)!=''){
    $("#suggestion-bar").show();
    $("#suggstion").text(app.getCommandsuggestion(cmd.elements['command'].value));
  }else{
    $("#suggestion-bar").hide();
  }
  
};

function hideSuggestion(){
  $("#suggestion-bar").hide();
}

$(document).keydown(
    function(e)
    {   
      switch(e.keyCode){
        case 32://space bar
          var d = e.srcElement || e.target;
           if (d.tagName.toUpperCase() != 'INPUT'){
            $(command).focus();
            $(command).val("");
          }
        break;
        case 40://key down
          var d = e.srcElement || e.target;
           if (d.tagName.toUpperCase() == 'INPUT')
           {
            $("#command").val(app.getLaterCmd());
           }else{
              if($(".task:focus").length==0){
                $(".task:last").focus();
              }else{
                var id=parseInt($(".task:focus")[0].id)+1;
                if(id==$(".task").length+1)
                  id=1;
                $("#"+id).focus();
              }   
           }
        break;
        case 38://key up
           var d = e.srcElement || e.target;
           if (d.tagName.toUpperCase() == 'INPUT')
           {
              $("#command").val(app.getPreviousCmd());
           }else{
              if($(".task:focus").length==0){
                $(".task:first").focus();
              }else{ 
                var id=parseInt($(".task:focus")[0].id)-1;
                if(id==0)
                  id=$(".task").length;
                $("#"+id).focus();
              }
           }
        break;
        case 46://delete
        case 8://backspace
          if($(".task:focus").length>0){
            var id=parseInt($(".task:focus")[0].id);
            console.log("delete "+id);
            shortCutCommand("delete "+id);
          }
        break;
        case 88://x
          if($(".task:focus").length>0){
            var id=parseInt($(".task:focus")[0].id);
            if($(title).text()=="Completed Tasks"){
              shortCutCommand("undone "+id);
            }else{
              shortCutCommand("done "+id);
            }            
          }
          break;
        case 80://p
          if($(".task:focus").length>0){
            var id=parseInt($(".task:focus")[0].id);
            shortCutCommand("postpone "+id);
          }
        case 90://ctrl+z
        	if(e.ctrlKey)
        		shortCutCommand("undo");
        break;
        case 89://ctrl+y
        	if(e.ctrlKey)
        		shortCutCommand("redo");
      }
    }
);


</script>

<div id="wrapper">
 <div class="center">
  <div class="main">
    <div class="alert alert-success" id="feedback" role="alert"></div>
    
    <div class="list">
      <div class="title" id="title"></div>
      <div class="group deadline">
        <div class="grouptitle" id="deadline_title"></div>
        <div class="tasklist" id="tasklist_deadline">

        </div>
      </div>

      <div class="group event">
        <div class="grouptitle" id="event_title"></div>
        <div class="tasklist" id="tasklist_event">

        </div>
      </div>

      <div class="group floating">    
       <div class="grouptitle" id="float_title"></div> 
       <div class="tasklist" id="tasklist_floating">

       </div>
     </div>
     <div class="group reserved">    
       <div class="grouptitle" id="reserved_title"></div> 
       <div class="tasklist" id="tasklist_reserved">
          </div>
     </div>
    <div class="group mixed">
        <div class="grouptitle" id="mixed_title"></div>
        <div class="tasklist" id="tasklist_mixed">

        </div>
      </div>

   </div>
   <div class="commandline">
    <form name="cmd">
      <input type="text" name="command" id="command" onkeydown="if(event.keyCode==13){sendCommand();}" onkeyup="getCommandsuggestion();" placeholder="Type your command here" autofocus/>
    </form>
  </div>
</div>
</div>
<div id="suggestion-bar">
  <div class="arrow-up"></div>
  <div class="command_suggestion" id="suggstion"></div>
</div>

</div>
</body>
</html>